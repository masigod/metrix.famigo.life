<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airtable ì—°ê²° í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #5a67d8;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        .config-input {
            margin: 10px 0;
        }
        .config-input label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .config-input input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¬ Airtable ì—°ê²° í…ŒìŠ¤íŠ¸</h1>

        <div class="warning">
            âš ï¸ <strong>ë³´ì•ˆ ì£¼ì˜:</strong> API KeyëŠ” ì•ˆì „í•˜ê²Œ ë³´ê´€í•˜ì„¸ìš”. ì´ í˜ì´ì§€ëŠ” í…ŒìŠ¤íŠ¸ ìš©ë„ì…ë‹ˆë‹¤.
        </div>

        <div class="test-section">
            <h2>1ï¸âƒ£ ì—°ê²° ì„¤ì •</h2>

            <div class="config-input">
                <label for="apiKey">API Key (Personal Access Token):</label>
                <input type="password" id="apiKey" placeholder="pat...">
            </div>

            <div class="config-input">
                <label for="baseId">Base ID:</label>
                <input type="text" id="baseId" placeholder="app...">
            </div>

            <div class="config-input">
                <label for="tableName">Table Name:</label>
                <input type="text" id="tableName" value="metrix_beauty">
            </div>

            <button onclick="testConnection()">ğŸ”Œ ì—°ê²° í…ŒìŠ¤íŠ¸</button>
            <button onclick="saveConfig()">ğŸ’¾ ì„¤ì • ì €ì¥</button>
            <button onclick="loadConfig()">ğŸ“‚ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°</button>

            <div id="connectionResult"></div>
        </div>

        <div class="test-section">
            <h2>2ï¸âƒ£ ë°ì´í„° í…ŒìŠ¤íŠ¸</h2>

            <button onclick="fetchRecords()" disabled id="fetchBtn">ğŸ“Š ë ˆì½”ë“œ ê°€ì ¸ì˜¤ê¸°</button>
            <button onclick="createTestRecord()" disabled id="createBtn">â• í…ŒìŠ¤íŠ¸ ë ˆì½”ë“œ ìƒì„±</button>
            <button onclick="fetchStatistics()" disabled id="statsBtn">ğŸ“ˆ í†µê³„ í™•ì¸</button>

            <div id="dataResult"></div>
        </div>

        <div class="test-section">
            <h2>3ï¸âƒ£ CSV ê°€ì ¸ì˜¤ê¸° í…ŒìŠ¤íŠ¸</h2>

            <input type="file" id="csvFile" accept=".csv">
            <button onclick="testCSVImport()" disabled id="importBtn">ğŸ“¤ CSV í…ŒìŠ¤íŠ¸ (ì²« 5ê°œë§Œ)</button>

            <div id="importResult"></div>
        </div>

        <div class="test-section">
            <h2>4ï¸âƒ£ ì—°ê²° ìƒíƒœ</h2>
            <div id="statusInfo" class="info">
                ì—°ê²°ë˜ì§€ ì•ŠìŒ
            </div>
        </div>
    </div>

    <script>
        let airtableConfig = {
            apiKey: '',
            baseId: '',
            tableName: 'metrix_beauty'
        };

        let isConnected = false;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        window.onload = function() {
            loadConfig();
        };

        // ì„¤ì • ì €ì¥
        function saveConfig() {
            const apiKey = document.getElementById('apiKey').value;
            const baseId = document.getElementById('baseId').value;
            const tableName = document.getElementById('tableName').value;

            if (!apiKey || !baseId || !tableName) {
                alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            // LocalStorageì— ì €ì¥ (ì‹¤ì œë¡œëŠ” ë³´ì•ˆìƒ ì„œë²„ì— ì €ì¥ ê¶Œì¥)
            localStorage.setItem('airtableConfig', JSON.stringify({
                baseId: baseId,
                tableName: tableName
                // API KeyëŠ” ë³´ì•ˆìƒ ì €ì¥í•˜ì§€ ì•ŠìŒ
            }));

            showResult('connectionResult', 'info', 'ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (API KeyëŠ” ì €ì¥ë˜ì§€ ì•ŠìŒ)');
        }

        // ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        function loadConfig() {
            const saved = localStorage.getItem('airtableConfig');
            if (saved) {
                const config = JSON.parse(saved);
                document.getElementById('baseId').value = config.baseId || '';
                document.getElementById('tableName').value = config.tableName || 'metrix_beauty';
                showResult('connectionResult', 'info', 'ì €ì¥ëœ ì„¤ì •ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            }
        }

        // ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testConnection() {
            const apiKey = document.getElementById('apiKey').value;
            const baseId = document.getElementById('baseId').value;
            const tableName = document.getElementById('tableName').value;

            if (!apiKey || !baseId || !tableName) {
                showResult('connectionResult', 'error', 'ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            airtableConfig = { apiKey, baseId, tableName };

            showResult('connectionResult', 'info', 'ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘... <span class="loading"></span>');

            try {
                const url = `https://api.airtable.com/v0/${baseId}/${encodeURIComponent(tableName)}?maxRecords=1`;

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || `HTTP ${response.status}`);
                }

                const data = await response.json();

                isConnected = true;
                enableButtons();

                showResult('connectionResult', 'success',
                    `âœ… ì—°ê²° ì„±ê³µ!<br>` +
                    `Base ID: ${baseId}<br>` +
                    `Table: ${tableName}<br>` +
                    `í…ŒìŠ¤íŠ¸ ë ˆì½”ë“œ: ${data.records.length}ê°œ í™•ì¸`
                );

                updateStatus('ì—°ê²°ë¨', 'success');

            } catch (error) {
                isConnected = false;
                disableButtons();

                showResult('connectionResult', 'error',
                    `âŒ ì—°ê²° ì‹¤íŒ¨: ${error.message}<br>` +
                    `<small>API Key, Base ID, Table Nameì„ í™•ì¸í•˜ì„¸ìš”.</small>`
                );

                updateStatus('ì—°ê²° ì‹¤íŒ¨', 'error');
            }
        }

        // ë ˆì½”ë“œ ê°€ì ¸ì˜¤ê¸°
        async function fetchRecords() {
            showResult('dataResult', 'info', 'ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” ì¤‘... <span class="loading"></span>');

            try {
                const url = `https://api.airtable.com/v0/${airtableConfig.baseId}/${encodeURIComponent(airtableConfig.tableName)}?maxRecords=10&view=Grid%20view`;

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${airtableConfig.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();

                let html = `âœ… ${data.records.length}ê°œ ë ˆì½”ë“œ í™•ì¸<br><br>`;

                data.records.forEach((record, i) => {
                    html += `<strong>ë ˆì½”ë“œ ${i + 1}:</strong><br>`;
                    html += `ID: ${record.id}<br>`;
                    html += `Name: ${record.fields.Name || '-'}<br>`;
                    html += `Email: ${record.fields.Email || '-'}<br>`;
                    html += `Status: ${record.fields.Status || '-'}<br>`;
                    html += '<hr>';
                });

                showResult('dataResult', 'success', html);

            } catch (error) {
                showResult('dataResult', 'error', `âŒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ${error.message}`);
            }
        }

        // í…ŒìŠ¤íŠ¸ ë ˆì½”ë“œ ìƒì„±
        async function createTestRecord() {
            showResult('dataResult', 'info', 'í…ŒìŠ¤íŠ¸ ë ˆì½”ë“œ ìƒì„± ì¤‘... <span class="loading"></span>');

            const testData = {
                fields: {
                    Name: `í…ŒìŠ¤íŠ¸_${Date.now()}`,
                    Email: `test_${Date.now()}@example.com`,
                    Phone: '010-0000-0000',
                    Status: 'ì˜ˆì•½ëŒ€ê¸°',
                    Gender: 'ê¸°íƒ€',
                    Nationality: 'Test',
                    Created_Time: new Date().toISOString(),
                    Sync_Status: 'synced'
                }
            };

            try {
                const url = `https://api.airtable.com/v0/${airtableConfig.baseId}/${encodeURIComponent(airtableConfig.tableName)}`;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${airtableConfig.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || `HTTP ${response.status}`);
                }

                const data = await response.json();

                showResult('dataResult', 'success',
                    `âœ… í…ŒìŠ¤íŠ¸ ë ˆì½”ë“œ ìƒì„± ì„±ê³µ!<br>` +
                    `ID: ${data.id}<br>` +
                    `Name: ${data.fields.Name}<br>` +
                    `Email: ${data.fields.Email}<br>` +
                    `<small>Airtableì—ì„œ í™•ì¸í•˜ì„¸ìš”.</small>`
                );

            } catch (error) {
                showResult('dataResult', 'error', `âŒ ë ˆì½”ë“œ ìƒì„± ì‹¤íŒ¨: ${error.message}`);
            }
        }

        // í†µê³„ í™•ì¸
        async function fetchStatistics() {
            showResult('dataResult', 'info', 'í†µê³„ ê³„ì‚° ì¤‘... <span class="loading"></span>');

            try {
                const url = `https://api.airtable.com/v0/${airtableConfig.baseId}/${encodeURIComponent(airtableConfig.tableName)}?pageSize=100`;

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${airtableConfig.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();

                // í†µê³„ ê³„ì‚°
                const stats = {
                    total: data.records.length,
                    byStatus: {},
                    byGroup: {}
                };

                data.records.forEach(record => {
                    const status = record.fields.Status || 'ë¯¸ì§€ì •';
                    const group = record.fields.Group || 'ë¯¸ì§€ì •';

                    stats.byStatus[status] = (stats.byStatus[status] || 0) + 1;
                    stats.byGroup[group] = (stats.byGroup[group] || 0) + 1;
                });

                let html = `ğŸ“Š <strong>í†µê³„ ì •ë³´</strong><br><br>`;
                html += `ì´ ë ˆì½”ë“œ: ${stats.total}ê°œ<br><br>`;

                html += `<strong>ìƒíƒœë³„:</strong><br>`;
                Object.entries(stats.byStatus).forEach(([status, count]) => {
                    html += `â€¢ ${status}: ${count}ê°œ<br>`;
                });

                html += `<br><strong>ê·¸ë£¹ë³„:</strong><br>`;
                Object.entries(stats.byGroup).forEach(([group, count]) => {
                    html += `â€¢ ${group}: ${count}ê°œ<br>`;
                });

                showResult('dataResult', 'success', html);

            } catch (error) {
                showResult('dataResult', 'error', `âŒ í†µê³„ í™•ì¸ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        // CSV ê°€ì ¸ì˜¤ê¸° í…ŒìŠ¤íŠ¸
        async function testCSVImport() {
            const fileInput = document.getElementById('csvFile');
            if (!fileInput.files.length) {
                showResult('importResult', 'error', 'CSV íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            showResult('importResult', 'info', 'CSV íŒŒì¼ ì²˜ë¦¬ ì¤‘... <span class="loading"></span>');

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = async function(e) {
                try {
                    // ê°„ë‹¨í•œ CSV íŒŒì‹± (ì‹¤ì œë¡œëŠ” PapaParse ì‚¬ìš© ê¶Œì¥)
                    const lines = e.target.result.split('\n');
                    const headers = lines[0].split(',');

                    // ì²« 5ê°œ ë ˆì½”ë“œë§Œ í…ŒìŠ¤íŠ¸
                    const testRecords = [];
                    for (let i = 1; i <= Math.min(5, lines.length - 1); i++) {
                        const values = lines[i].split(',');
                        const record = {};

                        headers.forEach((header, index) => {
                            const cleanHeader = header.replace(/^"|"$/g, '').trim();
                            const cleanValue = (values[index] || '').replace(/^"|"$/g, '').trim();
                            if (cleanValue) {
                                record[cleanHeader] = cleanValue;
                            }
                        });

                        if (record.Email) {
                            testRecords.push({ fields: record });
                        }
                    }

                    showResult('importResult', 'info',
                        `ğŸ“‹ ${testRecords.length}ê°œ í…ŒìŠ¤íŠ¸ ë ˆì½”ë“œ ì¤€ë¹„ë¨<br>` +
                        `<small>ì‹¤ì œ ê°€ì ¸ì˜¤ê¸°ëŠ” reservation-tracker-airtable.htmlì—ì„œ ìˆ˜í–‰í•˜ì„¸ìš”.</small>`
                    );

                    // ì²« ë²ˆì§¸ ë ˆì½”ë“œ í‘œì‹œ
                    if (testRecords.length > 0) {
                        const first = testRecords[0].fields;
                        let html = '<br><strong>ì²« ë²ˆì§¸ ë ˆì½”ë“œ ì˜ˆì‹œ:</strong><pre>';
                        html += JSON.stringify(first, null, 2);
                        html += '</pre>';

                        showResult('importResult', 'success',
                            `âœ… CSV íŒŒì¼ ì½ê¸° ì„±ê³µ!<br>` +
                            html
                        );
                    }

                } catch (error) {
                    showResult('importResult', 'error', `âŒ CSV ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`);
                }
            };

            reader.readAsText(file, 'UTF-8');
        }

        // ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
        function enableButtons() {
            document.getElementById('fetchBtn').disabled = false;
            document.getElementById('createBtn').disabled = false;
            document.getElementById('statsBtn').disabled = false;
            document.getElementById('importBtn').disabled = false;
        }

        function disableButtons() {
            document.getElementById('fetchBtn').disabled = true;
            document.getElementById('createBtn').disabled = true;
            document.getElementById('statsBtn').disabled = true;
            document.getElementById('importBtn').disabled = true;
        }

        // ê²°ê³¼ í‘œì‹œ
        function showResult(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `test-result ${type}`;
            element.innerHTML = message;
        }

        // ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateStatus(message, type) {
            const element = document.getElementById('statusInfo');
            element.className = type;
            element.innerHTML = `<strong>í˜„ì¬ ìƒíƒœ:</strong> ${message}<br>` +
                               `<small>ì‹œê°„: ${new Date().toLocaleTimeString('ko-KR')}</small>`;
        }
    </script>
</body>
</html>